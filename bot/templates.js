/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –æ —Ç—É—Ä–µ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∫–∞–Ω–∞–ª
 * @param {Object} tour - –û–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Ç—É—Ä–µ
 * @returns {String} - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ HTML-—Ä–∞–∑–º–µ—Ç–∫–µ
 */
const formatTourPost = (tour) => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ü–µ–Ω –∏ —Å–∫–∏–¥–æ–∫
  let currentPriceFormatted, oldPriceFormatted, discountPercent, priceText;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
  if (tour.currentPrice) {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
    currentPriceFormatted = new Intl.NumberFormat('ru-RU').format(tour.currentPrice);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
    if (tour.oldPrice && tour.discountPercentage) {
      // –í–∞—Ä–∏–∞–Ω—Ç 1: –ï—Å—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
      oldPriceFormatted = new Intl.NumberFormat('ru-RU').format(tour.oldPrice);
      discountPercent = tour.discountPercentage;
    } else {
      // –í–∞—Ä–∏–∞–Ω—Ç 2: –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º "—Å–∫–∏–¥–∫—É"
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å–∫–∏–¥–∫—É –æ—Ç 15% –¥–æ 25%
      discountPercent = Math.floor(Math.random() * (25 - 15 + 1)) + 15;
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º "—Å—Ç–∞—Ä—É—é" —Ü–µ–Ω—É
      const coefficient = 1 / (1 - discountPercent / 100);
      const calculatedOldPrice = Math.round(tour.currentPrice * coefficient);
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º "—Å—Ç–∞—Ä—É—é" —Ü–µ–Ω—É
      oldPriceFormatted = new Intl.NumberFormat('ru-RU').format(calculatedOldPrice);
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ü–µ–Ω–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º HTML
    priceText = `üí•<s>${oldPriceFormatted} ‚Ç∏</s>, —Å–∫–∏–¥–∫–∞: <b>${discountPercent}%</b>\n` +
                `–¶–µ–Ω–∞: <b>${currentPriceFormatted} ‚Ç∏</b>`;
  } else {
    // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –≤–æ–æ–±—â–µ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
    priceText = '–ü–æ –∑–∞–ø—Ä–æ—Å—É';
  }
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —É—á–µ—Ç–æ–º —Å—Ç—Ä–∞–Ω—ã
  const country = tour.country || '–¢—É—Ä—Ü–∏—é';
  const title = tour.title || `–ì–æ—Ä—è—â–∏–π —Ç—É—Ä! ${country}`;
  
  // –†–µ–π—Ç–∏–Ω–≥ (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö)
  const rating = tour.rating ? `üíØ –†–µ–π—Ç–∏–Ω–≥: ${tour.rating}/10\n` : '';
  
  // –î–∞–Ω–Ω—ã–µ –æ –ø–µ—Ä–µ–ª–µ—Ç–µ (–∑–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö)
  const fromCity = tour.fromCity || '–ê—Å—Ç–∞–Ω—ã';
  
  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞ —Å HTML-—Ä–∞–∑–º–µ—Ç–∫–æ–π
  let postText = `üî• <b>${title}</b>\n\n` +
         `üè® <b>${tour.name}</b>, ${tour.location}\n` +
         `${tour.description}\n` +
         `${rating}\n` +
         `üìÜ ${tour.date}\n` +
         `üåî ${parseInt(tour.nights) + 1} –¥–Ω–µ–π\n`;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∏—Ç–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
  if (tour.meal) {
    postText += `üçΩ ${tour.meal}\n`;
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç—è—Ö –∏ –ø–µ—Ä–µ–ª–µ—Ç–µ
  postText += `‚úàÔ∏è –∏–∑ ${fromCity}\n${priceText} –Ω–∞ ${tour.guests || '<b>2-—Ö</b>'}\n\n`;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å–ª—É–≥–∞—Ö
  postText += `‚úÖ –í —Ü–µ–Ω—É –≤–∫–ª—é—á–µ–Ω–æ:\n` +
         `- –ü–µ—Ä–µ–ª–µ—Ç\n` +
         `- –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –≤ –æ—Ç–µ–ª–µ ${tour.stars ? tour.stars + '*' : ''}\n` +
         `- –ü–∏—Ç–∞–Ω–∏–µ ${tour.meal || '–ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ'}\n` +
         `- –¢—Ä–∞–Ω—Å—Ñ–µ—Ä –∞—ç—Ä–æ–ø–æ—Ä—Ç-–æ—Ç–µ–ª—å-–∞—ç—Ä–æ–ø–æ—Ä—Ç\n` +
         `- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞\n` +
         `- –¢—É—Ä–∫–æ–¥\n\n`;
  
  // URL –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—É—Ä–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º tourPageUrl, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ–±—â–∏–π URL)
  const tourUrl = tour.tourPageUrl || 'https://tmtl.kz';
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –≤ HTML-—Ñ–æ—Ä–º–∞—Ç–µ
  postText += `üì≤ –ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:\n` +
         `‚úîÔ∏è <a href="https://wa.me/77078863633">whatsApp</a>\n` +
         `‚úîÔ∏è +7 (707) 886 36 33\n` +
         `üëâ <a href="${tourUrl}">–¢—É—Ä—ã –≤ ${country} –∏–∑ ${fromCity}</a>\n\n` +
         `‚ùóÔ∏è –°—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ –¥–µ–Ω—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏\n` +
         `üñå –ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à <a href="https://www.instagram.com/_timetotravel_krg">–ò–Ω—Å—Ç–∞–≥—Ä–∞–º</a>`;
  
  return postText;
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–µ–ª—è
 * @param {String} url - –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–µ–ª—è
 * @returns {Object} - –û–±—ä–µ–∫—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è Telegram
 */
const createHotelKeyboard = (url) => {
  return {
    inline_keyboard: [
      [
        {
          text: 'üëâ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± –æ—Ç–µ–ª–µ',
          url: url
        }
      ],
      [
        {
          text: 'üåê –ù–∞—à —Å–∞–π—Ç',
          url: 'https://tmtl.kz'
        }
      ]
    ]
  };
};

module.exports = {
  formatTourPost,
  createHotelKeyboard
};